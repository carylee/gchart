<?php
// $Id$

/**
  * @file
  * Drupal Module: highcharts
  * Provides custom functionality for building highcharts
 */

/**
 * Implementation of hook_init()
 */
/*function highcharts_init() {
  drupal_add_js( drupal_get_path('module', 'highcharts') . '/js/highcharts.js');
}*/

function highcharts_pieChart($vid, $skip=array()) {
  drupal_add_js( drupal_get_path('module', 'highcharts') . '/js/highcharts.js');
	$vocab = taxonomy_vocabulary_load($vid);
	$vname = $vocab->name;
	$extendedValues = array();
	$children = highcharts_gettaxtree_nonnull($vid, $skip);
	$numChildren = count($children);
  //drupal_add_js( '

$samplecode = <<<EOD
		$(document).ready(function() {
			var chart = new Highcharts.Chart({

				chart: {
					renderTo: 'chart-container',
					margin: [50, 200, 60, 170]
				},

				title: {
					text: 'Browser market shares at a specific website, 2008'
				},

				plotArea: {
					shadow: null,
					borderWidth: null,
					backgroundColor: null
				},

				tooltip: {
					formatter: function() {
						return '<b>'+ this.point.name +'</b>: '+ this.y +' %';
					}

				},

				plotOptions: {

					pie: {

						dataLabels: {

							enabled: true,

							formatter: function() {
								if (this.y > 5) return this.point.name;
							},
							color: 'white',
							style: {
								font: '13px Trebuchet MS, Verdana, sans-serif'
							}
						}
					}
				},

				legend: {
					layout: 'vertical',
					style: {
						left: 'auto',
						bottom: 'auto',
						right: '50px',
						top: '100px'

					}

				},

			        series: [{
					type: 'pie',
					name: 'Browser share',
					data: [{
							name: 'Firefox',
							y: 44.2,
							sliced: false
						},
						['IE7', 26.6],
						{
							name: 'IE6',
							y: 20,
							sliced: true
						},
						['Chrome', 3.1],
						{
							name: 'Safari',
							y: 2.7,
							sliced: false
						},
						['Opera', 2.3],
						['Mozilla', 0.4]
					]
					//data: [3.40, 1.05, 2.90, 1.65, 1.35, 2.59, 1.39, 3.07, 2.82]
				}]
			});
		});

EOD;

  drupal_add_js( $samplecode, 'inline', 'header');
  echo "<div id='chart-container' style='height:480; width:640;'></div>";
}

// From Chris' Code
function highcharts_gettaxtree_nonnull($vid, $skip=''){
	$children = taxonomy_get_children(arg(2), $vid);
      if(!$children) {
        $custom_parent = taxonomy_get_parents(arg(2));
          $parent_tree = array();
          foreach ($custom_parent as $custom_child => $key) {
            $parent_tree = taxonomy_get_tree($vid, $key->tid);
          }
          $children = $parent_tree;
      }
   	foreach ($children as $key => $value){
   		
   		$nodeCount = taxonomy_term_count_nodes($value->tid);
		if ($nodeCount == 0){
			unset($children[$key]);
			
		} else {
		}
		if($value->tid == $skip[0]){
			unset($children[$key]);
		} else {
		}
	}
	$children = array_values($children);
    return $children;
}
/**
 * Sorts array by node count.
 */
function highcharts_cmp($a, $b)
{
    if ($a['count'] == $b['count']) {
        return 0;
    }
    return ($a['count'] > $b['count']) ? -1 : 1;
}
